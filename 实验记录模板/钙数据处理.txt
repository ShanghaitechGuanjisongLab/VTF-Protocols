# OIR配准转TIFF
双光子显微镜拍摄得到的原始数据文件为OIR格式。我们认为，同一次拍摄的时间段内，可能会因小鼠挣扎，视野发生XY平移；不同的拍摄会话之间，除了XY平移，还可能会发生旋转、缩放和剪切等变换。不考虑Z方向变换。因此，需要对拍摄出来的视频进行配准，确保细胞位置不变。
OIR是Olymupus私有格式，不方便修改，因此输出格式采用TIFF。使用[统一实验分析作图](https://github.com/ShanghaitechGuanjisongLab/Unified-Experimental-Analysis-and-Figuring/releases)MATLAB工具箱，配准的基本原理如下：
首先各文件分别进行内部配准，只考虑XY平移，核心算法是MATLAB内置的normxcorr2，实际使用【统一实验分析作图】的BatchOirRegisterTiff函数：
1. 将每个OIR文件视频，按时间切割成大小为30~35帧的块，逐块处理，这是因为GPU显存有限，不能一次性全部读入。
2. 以标准差为20的二维高斯平滑核对所有图像执行二维高斯滤波，产生的模糊图作为“背景”，从原图中扣除，以消除图像整体明暗大区对互相关计算的影响
3. 对块内所有图像做两两归一化互相关计算（normxcorr2），得到每张图（参照图）对其它所有图（相关图）的归一化互相关矩阵，整合在4维数组中，维度顺序为宽度×高度×参照图×相关图。
4. 将互相关矩阵沿相关图维度求和，得到每张参照图的总和互相关矩阵，然后在宽度和高度两个维度上寻找最大值点，那个点相对于图像中心的坐标，就是参照图需要平移的偏移量
5. 将每张参照图的XY偏移量记录下来，然后执行平移，再将所有平移后的图求平均，得到块平均图。
6. 处理完所有块后，每个块都得到一串XY偏移量和一张块平均图。将这些块平均图在时间轴上串联，再次切割成30~35帧的块，同样做归一化互相关XY平移配准，得到一系列二级块XY偏移和块平均图。
7. 以此类推，逐级向上配准，直到某一级只剩一块。将这一块得到的XY偏移量，向下一级分发，即将下一级每帧的XY偏移量加上该帧所在上级块的XY偏移量。
8. 以此类推，逐级向下分发，最终得到原视频所有时间帧的全局XY偏移量。用这套全局偏移量对原视频的每个时间帧执行平移，得到文件内配准完成的视频，并求平均得到该文件的平均图，输出为TIFF。
接下来执行文件间手动配准。文件间除了平移，还可能存在旋转、缩放、剪切等扭曲，需要人工比对。
1. 用ImageJ打开首日拍摄的 Reference OIR 作为基准图。
2. 打开每个文件内配准结果TIFF的平均图，与基准图比对。在基准图中圈出3~4个在平均图中也出现的关键、清晰的特征，作为 ImageJ ROI 保存，称为固定ROI。然后在平均图中也圈出对应的特征，圈的顺序和圆心位置必需和平均图精准匹配，即使得基准图和平均图中相同的特征点被相同的圈定位，同样作为 ImageJ ROI 保存，称为移动ROI。
3. 使用【统一实验分析作图】的RoiRegister生成变换矩阵并进行试配。具体来说，将每个ROI文件圈出的ROI圆心XY坐标纵向排列，横向排列不同的ROI，得到XY×ROI矩阵。然后追加全1的第3行，得到XY1×ROI矩阵。将固定图和平均图的矩阵相除，即得到变换矩阵。将变换矩阵用MATLAB内置imwarp算法，应用到对应平均图上，得到试配图。
4. 用ImageJ打开试配图，与基准图进行人工比对，确认配准效果。如果配准效果不好，则需要重新圈ROI，重新生成变换矩阵并试配。重复这套流程，直到得到满意的试配图。
5. 为每个平均图重复上述步骤，直到所有平均图都得到满意的试配图，以及对应的变换矩阵。
6. 为每个完成平移配准的TIFF视频，应用对应的变换矩阵，得到新的TIFF，即为完成配准的结果。使用【统一实验分析作图】的BatchTiffTransform。同时计算出所有TIFF视频的总体平均图一张。

# 细胞信号值测量
ImageJ打开配准好的TIFF，圈出所有亮起的细胞。应当逐一查看所有TIFF，将其中亮起的细胞取并集，得到所有细胞的ROI，保存。
使用【统一实验分析作图】的BatchTiffMeasure，测量所有细胞在所有拍摄中的亮度变化曲线。对每个细胞，除了将圈内的像素值求平均外，还要在总体平均图中，取圈外20像素的半径范围内，总体平均图的像素值小于该范围内的中位数像素值的所有像素坐标，然后将测量图中同样坐标位置的像素平均值求出，作为散射光。用测量的像素平均值减去散射光，得到最终的测量值。

# 实验日志
日期    鼠名    步骤